name: Reusable deployment workflow

on:
  workflow_call:
    inputs:
      instance_name:
        description: "Instance name (e.g., vaalikoppi, vaalikoppi-kaplaaki)"
        required: true
        type: string
      app_service_name:
        description: "Azure App Service name"
        required: true
        type: string
      image_tag:
        description: "Docker image tag/name (e.g., vaalikoppi, vaalikoppi-kaplaaki)"
        required: true
        type: string
      cache_scope:
        description: "GitHub Actions cache scope"
        required: false
        type: string
        default: "default"
    secrets:
      CLIENT_ID:
        required: true
      TENANT_ID:
        required: true
      SUBSCRIPTION:
        required: true
      REGISTRY_NAME:
        required: true
      REGISTRY_LOGIN_SERVER:
        required: true

permissions:
  id-token: write

env:
  AZURE_CORE_OUTPUT: none

jobs:
  build:
    environment: Production
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_PASSWORD: ci-password
          POSTGRES_DB: vaalikoppi
          POSTGRES_USER: vaalikoppi
        options: >-
          --health-cmd pg_isready
          --health-interval 6s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v2
      - name: Log in to Azure
        uses: Azure/login@v1
        with:
          client-id: ${{ secrets.CLIENT_ID }}
          tenant-id: ${{ secrets.TENANT_ID }}
          allow-no-subscriptions: true

      - name: Docker login to ACR
        run: az acr login --name ${{ secrets.REGISTRY_NAME }}

      - uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ secrets.REGISTRY_LOGIN_SERVER }}/vaalikoppi/${{ inputs.image_tag }}:${{ github.sha }}
          cache-from: type=gha,scope=${{ inputs.cache_scope }}
          cache-to: type=gha,mode=max,scope=${{ inputs.cache_scope }}
          build-args: |
            "DATABASE_URL=postgres://vaalikoppi:ci-password@localhost:5432/vaalikoppi"
          allow: |
            network.host
            security.insecure
          network: host

      - name: Azure logout
        run: |
          az logout

  e2e:
    environment: Production
    runs-on: ubuntu-latest
    needs: build
    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_PASSWORD: ci-password
          POSTGRES_DB: vaalikoppi
          POSTGRES_USER: vaalikoppi
        options: >-
          --health-cmd pg_isready
          --health-interval 6s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - uses: Azure/login@v2
        with:
          client-id: ${{ secrets.CLIENT_ID }}
          tenant-id: ${{ secrets.TENANT_ID }}
          allow-no-subscriptions: true

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Docker login to ACR
        run: az acr login --name ${{ secrets.REGISTRY_NAME }}

      - name: Run vaalikoppi and tests
        run: |
          docker run \
            -e PORT=80 \
            -e DATABASE_URL='postgres://vaalikoppi:ci-password@localhost:5432/vaalikoppi' \
            -e HMAC_KEY='1234' \
            -e ADMIN_PASSWORD='CI_ADMIN_PASSWORD' \
            --name vaalikoppi \
            --network host \
            -d \
            ${{ secrets.REGISTRY_NAME }}.azurecr.io/vaalikoppi/${{ inputs.image_tag }}:${{ github.sha }} && \
            docker ps && \
            docker container logs vaalikoppi && \
            wget http://localhost:80 || \
            docker ps && \
            docker container logs vaalikoppi && \
            ADMIN_PASSWORD='CI_ADMIN_PASSWORD' PORT=80 npx playwright test

  deploy:
    environment: Production
    runs-on: ubuntu-latest
    needs: e2e

    steps:
      - uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.CLIENT_ID }}
          tenant-id: ${{ secrets.TENANT_ID }}
          subscription-id: ${{ secrets.SUBSCRIPTION }}

      - name: Validate prerequisites
        shell: bash
        run: |
          set -euo pipefail
          RG="vaalikoppi_group"
          APP="${{ inputs.app_service_name }}"
          PRINCIPAL_ID=$(az webapp identity show -g "$RG" -n "$APP" --query principalId -o tsv || true)
          if [ -z "$PRINCIPAL_ID" ]; then
            echo "Error: Web App '$APP' does not have a system-assigned identity enabled."
            echo "Enable once outside CI: az webapp identity assign -g $RG -n $APP"
            exit 1
          fi
          echo "Web App identity present: $PRINCIPAL_ID"

      - name: Enable ACR via managed identity
        run: |
          az webapp config set \
            --resource-group vaalikoppi_group \
            --name ${{ inputs.app_service_name }} \
            --generic-configurations '{"acrUseManagedIdentityCreds": true}'

      - name: Point webapp to image
        shell: bash
        run: |
          set -euo pipefail
          RG="vaalikoppi_group"
          APP="${{ inputs.app_service_name }}"
          IMAGE="${{ secrets.REGISTRY_LOGIN_SERVER }}/vaalikoppi/${{ inputs.image_tag }}:${{ github.sha }}"
          SITE_ID=$(az webapp show -g "$RG" -n "$APP" --query id -o tsv)
          CONFIG_ID="${SITE_ID}/config/web"
          az resource update \
            --ids "$CONFIG_ID" \
            --set properties.linuxFxVersion="DOCKER|${IMAGE}"

      - name: Show site container config
        shell: bash
        run: |
          RG="vaalikoppi_group"
          APP="${{ inputs.app_service_name }}"
          SITE_ID=$(az webapp show -g "$RG" -n "$APP" --query id -o tsv)
          CONFIG_ID="${SITE_ID}/config/web"
          az resource show \
            --ids "$CONFIG_ID" \
            --query "properties.{linuxFxVersion:linuxFxVersion,acrUseManagedIdentityCreds:acrUseManagedIdentityCreds,acrUserManagedIdentityId:acrUserManagedIdentityId}"

      - name: Azure logout
        run: az logout
